{% extends 'base.html.twig' %}

{% block title %}

{% endblock %}

{% block body %}

    <div class="row" id="plateau"
         style="background: url('{{ asset('assets/img/fond_du_feu.png') }}'); background-size: cover;">
        {{ include('game/plateau.html.twig') }}
    </div>
{% endblock %}

{% block javascripts %}
    <style>
        .selectedCardTerrain {
            border: red solid 3px;
        }
        .selectedCardDeck {
            border: red solid 3px;
        }
    </style>
    <script>
        function selection() {
            $(this).css('border', '3px solid red')
        }
        function checkError(data,action) {
            if (data.check == "error") {
                alert(data.message)
                $(".selectedCardTerrain").removeClass("selectedCardTerrain")
                $(".selectedCardDeck").removeClass("selectedCardDeck")
            } else {
                console.log(action)
                refreshPlateau();
                arrayJoueur = [];
                arrayTerrain = [];
                timeStop = false
            }
        }

        var arrayTerrain = [];
        var arrayJoueur = [];
        var timer;
        var timeStop = false
        $(document).ready(function () {
            $('#boutons').hide()
            refreshPlateau()

//SELECTION
            $(document).on('click', '.carte_terrain', function () {
                var id = $(this).attr("id");
                if (arrayTerrain.indexOf(id) == -1) {
                    if (arrayTerrain.length == 5) {
                        alert('Vous ne pouvez pas sélectionner plus de cinq cartes')
                        $(this).removeClass("selectedCardTerrain")

                    } else {
                        arrayTerrain.push(
                            id
                        )
                        console.log("Ajout de " + id)
                        $(this).addClass("selectedCardTerrain")
                    }
                } else {
                    console.log(arrayTerrain.indexOf(id))
                    console.log("Retrait de " + id)
                    $(".selectedCardTerrain").removeClass("selectedCardTerrain")
                    arrayTerrain.splice(0, id)
                    console.log(arrayTerrain.indexOf(id))
                }
                console.log("Tableau actuel: " + arrayTerrain)
            });

//SELECTION
            $(document).on('click', '.carte_joueur', function () {
                var id = $(this).attr("id");
                if (arrayJoueur.indexOf(id) == -1) {
                    if (arrayJoueur.length == 5) {
                        alert('Vous ne pouvez pas sélectionner plus de cinq cartes')
                        $(this).removeClass("selectedCardDeck")

                    } else {
                        arrayJoueur.push(
                            id
                        )
                        console.log("Ajout de " + id)
                        $(this).addClass("selectedCardDeck")
                    }
                } else {
                    console.log(arrayJoueur.indexOf(id))
                    console.log("Retrait de " + id)
                    $(".selectedCardDeck").removeClass("selectedCardDeck")
                    arrayJoueur.splice(0, id)
                    console.log(arrayJoueur.indexOf(id))
                }
                console.log("Tableau joueur actuel: " + arrayJoueur)
            });

        })

        //PRENDRE
        $(document).on("click", '#prendre', function () {
            console.log('Prendre')
            $.ajax({
                url: "{{ path('prendre_action', {game: game.id}) }}",
                data: {arrayTerrain: arrayTerrain},
                method: 'POST',
                success: function (data) {
                    checkError(data,'prendre ok')
                }
            })
        })


        //VENDRE
        $(document).on("click", '#vendre', function () {
            console.log('Vendaison')
            $.ajax({
                url: "{{ path('vendre_action', {game: game.id}) }}",
                data: {arrayJoueur: arrayJoueur},
                method: 'POST',
                success: function (data) {
                    console.log(data)
                    checkError(data,'vendre ok')
                }
            })
        })
        //ECHANGER
        $(document).on("click", '#echange', function () {
            console.log('echangeation')
            $.ajax({
                url: "{{ path('echange_action', {game: game.id}) }}",
                data: {arrayJoueur: arrayJoueur, arrayTerrain: arrayTerrain},
                method: 'POST',
                success: function (data) {
                    console.log(data)

                    if (data.check == "error") {
                        alert(data.message)
                    } else {
                        console.log('prendu')
                        refreshPlateau();
                        arrayJoueur = [];
                        arrayTerrain = [];
                        timeStop = false
                    }
                }
            })
        })

        function refreshPlateau() {
            console.log('refreshplateau')
            $.ajax({
                url: "{{ path('qui_joue', {game: game.id}) }}",
                //data:,
                method: 'POST',
                success: function (data) {
                    console.log(data)
                    if (data == 'monadversairejoue') {
                        $('#boutons').hide()
                        if (timeStop == false) {
                            console.log('tac');
                            timer = setInterval(refreshPlateau, 2000);
                            timeStop = true;
                        }
                    } else {
                        $('#plateau').empty().load("{{ path('refresh_plateau', {game:game.id}) }}")
                        $('#plateau').show()
                        clearInterval(timer)
                        timeStop = true
                    }
                }
            })
        }
    </script>

{% endblock %}